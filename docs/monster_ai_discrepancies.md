# Monster AI Discrepancies

## Regression test summary

Manual regression passes compare the reconstructed C sources against the Binary Ninja HLIL dump to validate spawn, movement, attack, pain, and death behaviour for each monster. Deviations and the corrective work needed to reach parity are summarised below.

### Missing mmove and reaction coverage
- **Cyborg** – Retail HLIL exposes the idle/stand tables at frames 0x52–0x7d plus walk/run segments at 0x12–0x17 and 0x4f–0x51, alongside three ranged attack chains (0x18–0x23, 0x2f–0x34, 0x35–0x3a) and paired pain reactions (0x49–0x4e, 0x4f–0x51).【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68309-L68434】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68457-L68480】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】
- **Kigrax** – Eight mmove blocks cover hover/scan (0–48), alternating patrols (61–104), long/dash strafes (105–138), and the attack/pain/death tables at 139–168 that drive the salvo callback at frame 163.【F:docs/kigrax_hlil_notes.md†L8-L20】

| Monster | Scenario | Observed result | Expected baseline | Alignment work |
| --- | --- | --- | --- | --- |
| Cyborg | Movement coverage | Frame constants collapse the behaviour into frames 0–17 with compact mmove arrays for stand, walk, run, attack, pain, and death, eliminating distinct idle and locomotion phases.【F:src/game/m_cyborg.c†L13-L191】 | Retail mmove tables span frame IDs 0x12–0x7d via helpers `sub_100245d0`, `sub_10024610`, and related dispatchers, yielding discrete stand, idle, walk, run, and attack chains with unique callbacks.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27909-L27923】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68309-L68434】 | Recreate the retail mmove arrays (including segments such as `data_100516a0` and `data_10051730`) and wire them into the movement callbacks so the full animation set plays in the correct order.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68309-L68434】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】 |
| Cyborg | Attack cadence & variety | A fixed four-frame burst uses a single `cyborg_attack_think` callback with a 1.2 s cooldown, producing identical double-shots every cycle.【F:src/game/m_cyborg.c†L120-L147】 | `sub_10024e00` randomly selects between three ranged mmove blocks and seeds per-frame callbacks for projectile timing, creating varied burst lengths.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27660-L27684】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】 | Port the attack dispatcher and per-frame callback table so that the cyborg cycles through the three retail attack chains with their native delays.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27660-L27684】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】 |
| Cyborg | Pain handling | Pain uses a single sound, enforces a 2.0 s debounce, and plays a two-frame flinch before resuming run behaviour.【F:src/game/m_cyborg.c†L149-L163】 | `sub_100246a0` alternates between `mutpain1` and `mutpain2`, uses `*(self+0x210)` to enforce a three-second cooldown, and switches between longer mmove sequences.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27429-L27467】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68457-L68480】 | Mirror the pain timer field, add the second sound slot, and restore mmove pointers `data_100516f8`/`data_10051730` with their callbacks so stagger timing matches retail.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68457-L68480】 |
| Cyborg | Audio fidelity | Weapon fire maps to `deatom/dfire.wav` and the landing thud is never played, reducing audio variety.【F:src/game/m_cyborg.c†L209-L217】 | HLIL loads the three `mutatck` shots plus a heavy `thud1` channel for landings and impact emphasis.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27887-L27899】 | Replace the single `sound_attack` with the three-sample table and reinstate the dedicated thud trigger to match the retail soundscape.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27887-L27899】 |
| Cyborg | Behavioural flags | The reconstruction omits the stand-ground toggles and scripted callbacks triggered when health thresholds are crossed.【F:src/game/m_cyborg.c†L120-L147】 | Retail code flips `*(self+0x3c)` and schedules `sub_10024920` timers to anchor the cyborg when wounded.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27435-L27539】 | Introduce the missing flag writes and timer-driven callbacks so low-health behaviour matches the original DLL.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27435-L27539】 |
| Spider | Animation breadth | Mmove tables now cover the full 0x00-0xA4 span (stand, walk, run1/2, attack left/right/dual, melee, pain, death), matching retail ordering.【F:src/game/m_spider.c†L15-L305】 | Retail mmoves span 0x00-0xA4 with selectors in `sub_1002d440`/`sub_1002d660`/`sub_1002d8f0` and the data tables at 0x1005ca00-0x1005cff8.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L33792-L33925】【F:references/Assembly/Oblivion/gamex86.dll_disassembly.txt†L122538-L122974】【F:references/Assembly/Oblivion/gamex86.dll_disassembly.txt†L59786-L59786】 | Aligned: mmove tables and selectors match HLIL/assembly, and the regression fixture tracks the ranges.【F:src/game/m_spider.c†L15-L305】【F:tests/fixtures/spider_expected_behaviour.json†L1-L16】 |
| Spider | Attack cadence | Ranged attack selects left/right/dual rockets and melee picks between primary/secondary chains, matching the HLIL dispatch flow.【F:src/game/m_spider.c†L572-L606】 | `sub_1002d8f0` and `sub_1002d750` randomize the rocket/melee chains while `sub_1002d6c0` handles melee hits (20-24 damage, kick 300).【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L33874-L33925】 | Aligned: dispatchers and hit callbacks mirror the HLIL logic and values.【F:src/game/m_spider.c†L458-L606】 |
| Spider | Pain / recovery | Pain uses a 3.0s debounce, swaps skinnum below half, and selects between pain1/pain2 mmoves.【F:src/game/m_spider.c†L614-L653】 | `sub_1002d9e0` applies the 3.0s gate, skin swap, and two pain sequences in the retail DLL.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L33940-L34200】 | Aligned: pain debounce and mmove selection now match the HLIL behavior.【F:src/game/m_spider.c†L614-L653】 |
| Spider | Audio cues | Sound setup loads gladiator melee/pain/idle/search, mutant thud1, and the spider sight cue; no death-specific slot is used.【F:src/game/m_spider.c†L712-L720】 | HLIL loads the same clip set for spider audio, including both pain voices and the unique sight cue.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L34169-L34191】 | Aligned: audio table matches the HLIL loadout and the regression fixture verifies it.【F:tests/fixtures/spider_expected_behaviour.json†L17-L28】 |
| Spider | Spawnflag handling | Spawnflag bit 8 selects the corpse hull mins -32,-32,-30 maxs 32,32,0 with MOVETYPE_TOSS and DEADMONSTER.【F:src/game/m_spider.c†L745-L757】 | The retail DLL checks bit 8 to apply the corpse hull and deadmonster setup.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L34192-L34205】 | Aligned: spawnflag check and hull match HLIL and the spawn manifest snapshot.【F:tests/expected_spawn_manifest.json†L6665-L6677】【F:src/game/m_spider.c†L745-L757】 |
| Kigrax | Strafing/scouting AI | Stand/walk/run/attack collapsed into four frames so the sentry hovers in place without the retail strafing loops.【F:src/game/m_kigrax.c†L1-L74】 | HLIL wires eight mmove blocks (0–168) with idle, patrol, dash, and attack controllers through `0x100291b0`, `0x10028f20`, and `0x10028ee0`.【F:docs/kigrax_hlil_notes.md†L3-L20】 | `kigrax_init_moves`, `kigrax_idle_select`, `kigrax_walk_select`, and `kigrax_run_select` now seed the recovered mmove tables so stand/search/run mirror the HLIL state machine.【F:src/game/m_kigrax.c†L114-L220】【F:src/game/m_kigrax.c†L318-L376】 |
| Kigrax | Attack cleanup | The burst uses a single-frame blaster shot and immediately falls back to the run selector, so bounding box toggles and the four-shot salvo never trigger.【F:src/game/m_kigrax.c†L260-L307】 | HLIL’s `0x1002f030` callback adjusts the hull, spawns four bolts, and only then returns to the patrol selectors.【F:docs/kigrax_hlil_notes.md†L20-L20】 | Port the `0x1002f030` bounding-box/salvo routine so the attack frames can fire all four projectiles and restore the crouched hull before rejoining the strafing loop. |

## monster_cyborg

### HLIL initialization snapshot (0x10025234–0x100253da)
- Sound table loads a full set of cyborg effects: three melee shots, death, idle loop, two pain variants, sight/search calls, three footfalls, and a heavy landing thud.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27887-L27899】
- Spawns the stock model with a bounding box of {-16, -16, -38} to {16, 16, 27}, 300 HP, and -120 gib health by writing the model path, mins/maxs, `health`, and `gib_health` fields directly.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27902-L27908】
- Core AI helpers are wired to specific routines: `sub_100245d0` (stand) → `data_10051540` (frames 0x7d–0x7d), `sub_100245e0` (idle loop) → `data_10051560` (frames 0x7d–0x7d), `sub_10024610`/`sub_10024620` (locomotion state machine using additional mmoves such as `data_100516a0` at frames 0x12–0x17 and `data_10051730` at frames 0x4f–0x51), and a randomised attack dispatcher `sub_10024e00` that selects between mmoves `data_10051958` (0x18–0x23), `data_10051a48` (0x2f–0x34), and `data_10051aa0` (0x35–0x3a).【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27909-L27918】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68309-L68428】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68428-L68434】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】
- Pain handling `sub_100246a0` throttles reactions through the `*(self+0x210)` timer, randomly alternates between `mutpain1` and `mutpain2`, and swaps to mmoves `data_100516f8` (0x49–0x4e) or `data_10051730` (0x4f–0x51).【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27892-L27894】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27429-L27467】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68457-L68480】
- Death and gib logic routes through `sub_100250b0`, which plays `mutdeth1`, toggles corpse flags, and triggers complex gibbing when `health` falls below thresholds.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27915-L27920】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27660-L27727】

### Current source implementation (`src/game/m_cyborg.c`)
- Defines compact frame spans (stand 0, walk 1–4, run 5–8, attack 9–12, pain 13–14, death 15–17) with short mframe arrays.【F:src/game/m_cyborg.c†L13-L191】
- Replaces the multi-sample weapon audio with a single `deatom/dfire.wav` shot and only keeps `mutpain1` as the pain cue; no dedicated thud channel is played.【F:src/game/m_cyborg.c†L209-L217】【F:src/game/m_cyborg.c†L149-L163】
- Attack behaviour fires every 1.2 s via `monsterinfo.attack_finished` and reuses a two-step `cyborg_attack_think` callback inside four zero-distance frames.【F:src/game/m_cyborg.c†L120-L147】

### Discrepancies
- **Movement coverage** – Retail HLIL drives distinct stand, idle, walk/run, and attack mmoves across frame IDs 0x12–0x7d, while the reconstruction collapses everything into 0–17, losing the original pacing, footstep timing, and transitions.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27909-L27923】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68309-L68434】【F:src/game/m_cyborg.c†L13-L145】
- **Attack cadence & variety** – `sub_10024e00` randomises among three ranged sequences and seeds per-frame callbacks, whereas the C version runs a fixed four-frame burst with a single cooldown and no variation.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27660-L27684】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】【F:src/game/m_cyborg.c†L120-L147】
- **Pain handling** – HLIL alternates between two pain sounds, enforces a three-second debounce through `*(self+0x210)`, and can branch to separate mmoves; the port plays one sound and hardcodes a two-second pause with a two-frame flinch.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27429-L27467】【F:src/game/m_cyborg.c†L149-L163】
- **Audio fidelity** – Original code keeps the three `mutatck` shots and a landing `thud1`; the new code swaps in `deatom/dfire` and never emits the heavy impact sound, altering player feedback.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27887-L27899】【F:src/game/m_cyborg.c†L209-L217】
- **Behavioural flags** – HLIL toggles `*(self+0x3c)` to force stand-ground behaviour when health drops and uses scripted callbacks `sub_10024920` on timers, none of which are mirrored in the simplified translation.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27435-L27539】【F:src/game/m_cyborg.c†L120-L147】

### Alignment plan
- Expand the cyborg's mmove tables beyond the 0–17 frame set so that stand, idle, locomotion, and attack states can replay the original animations from `data_10051540`, `data_10051560`, `data_100516a0`, and `data_10051730`.【F:src/game/m_cyborg.c†L13-L145】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68309-L68434】
- Recreate the `sub_10024e00` attack dispatcher with its randomised selection over the three mmove segments so burst variety and timing match retail.【F:src/game/m_cyborg.c†L120-L147】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68659-L68770】
- Mirror the retail pain throttle by tracking the `*(self+0x210)` timer, alternating between both pain sounds, and reusing the longer stagger mmoves referenced by `data_100516f8` and `data_10051730`.【F:src/game/m_cyborg.c†L149-L163】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27429-L27467】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L68457-L68480】
- Restore the multi-sample weapon audio and the heavy landing thud triggers so combat audio cues align with the DLL snapshot.【F:src/game/m_cyborg.c†L209-L217】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27887-L27899】
- Add the wounded stand-ground flag writes and scheduled callbacks from `sub_10024920` so that low-health behaviour respects the original scripted pauses.【F:src/game/m_cyborg.c†L120-L147】【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L27435-L27539】

### Automated regression coverage

- The cyborg regression fixture `tests/fixtures/cyborg_expected_behaviour.json` describes the expected frame ranges, dispatch thresholds, timers, and audio cues recovered from the restored mmove tables.【F:tests/fixtures/cyborg_expected_behaviour.json†L1-L39】
- `tests/test_cyborg_regression.py` parses `m_cyborg.c`, compares its definitions to the fixture, and simulates representative combat timelines to ensure state transitions, cooldowns, and sound triggers remain aligned with the captured baseline.【F:tests/test_cyborg_regression.py†L1-L147】

## monster_spider

### HLIL initialization snapshot (0x1002ddb5-0x1002df3b)
- Sound table loads gladiator melee1/2/3, mutant thud1, gladiator pain1/2, idle, search, and the spider sight cue; no dedicated death sound is registered.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L34169-L34191】
- Defaults set health to 400, gib_health to -175, and bbox mins -32,-32,-35 maxs 32,32,32; spawnflag bit 8 swaps to the corpse hull mins -32,-32,-30 maxs 32,32,0 with MOVETYPE_TOSS and DEADMONSTER.【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L34180-L34205】
- Mmove ranges map to the assembly tables: stand 0x00-0x36 (`data_1005ca00`), walk 0x37-0x40 (`data_1005ca88`), run1 0x41-0x4a (`data_1005cb10`), run2 0x4b-0x50 (`data_1005cb68`), attack left/right/dual 0x51-0x62 (`data_1005cc70`/`data_1005ccc0`/`data_1005cd30`), melee 0x63-0x6e (`data_1005cbb8`/`data_1005cc20`), pain 0x6f-0x7c (`data_1005cd88`/`data_1005cdf8`), and death 0x7d-0xa4 (`data_1005cef8`/`0x1005cff8`).【F:references/Assembly/Oblivion/gamex86.dll_disassembly.txt†L122538-L122974】【F:references/Assembly/Oblivion/gamex86.dll_disassembly.txt†L59786-L59786】
- Attack dispatch `sub_1002d8f0` selects left/right/dual rockets, `sub_1002d7b0`/`sub_1002d850` fire the rockets (damage 50, speed 500, muzzle flashes 0x8a/0x8b), and `sub_1002d6c0` applies melee hits (20-24 damage, kick 300).【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L33874-L33925】
- Pain and death flow through `sub_1002d9e0` (3.0s debounce, skinnum swap below half), `sub_1002dbd0` (death1/death2 selection and gibs), and `sub_1002db70` (corpse hull).【F:references/HLIL/oblivion/gamex86.dll_hlil.txt†L33940-L34200】

### Current source implementation (`src/game/m_spider.c`)
- Frame constants and mmove tables now cover 0x00-0xA4 for stand, walk, run1/2, attack left/right/dual, melee primary/secondary, pain1/2, and death1/2.【F:src/game/m_spider.c†L15-L305】
- Attack and melee selectors mirror the HLIL dispatchers, with rocket damage/speed and melee damage/kick matching retail values.【F:src/game/m_spider.c†L458-L606】
- Sound setup loads gladiator melee/pain/idle/search, mutant thud1, and the spider sight cue with no death-specific slot.【F:src/game/m_spider.c†L712-L720】
- Spawn defaults match HLIL, including the corpse spawnflag hull and MOVETYPE_TOSS branch on bit 8.【F:src/game/m_spider.c†L722-L757】

### Discrepancies
- None recorded after the reconstruction; regression fixtures now mirror the HLIL frame ranges, audio table, and corpse spawnflag handling.【F:tests/fixtures/spider_expected_behaviour.json†L1-L28】【F:tests/test_spider_regression.py†L1-L156】

### Alignment status
- Completed: mmove tables, selectors, and frame ranges now match the HLIL/assembly mapping for stand, walk, run, attacks, melee, pain, and death.【F:src/game/m_spider.c†L15-L696】
- Completed: sound table entries align with the HLIL loadout, including both pain clips and the spider sight cue.【F:src/game/m_spider.c†L712-L720】
- Completed: spawnflag bit 8 maps to the corpse hull and deadmonster setup used by the retail DLL.【F:src/game/m_spider.c†L745-L757】【F:tests/expected_spawn_manifest.json†L6665-L6677】

## monster_kigrax

### HLIL spawn/state snapshot
- The spawn routine seeds the hover/search/sight/pain/death audio table, installs the hover selectors (`0x100291b0`/`0x10029220`), strafing dispatchers (`0x10028f20`/`0x10028ee0`), and sight handler (`0x10028e60`), and writes the bbox/movetype/yaw-speed/viewheight defaults captured in the manifest.【F:docs/kigrax_hlil_notes.md†L3-L7】【F:docs/manifests/spawn_manifest.json†L2298-L2351】
- Eight mmove tables span frames 0–168 (idle hover/scan, patrol CCW/CW, long/dash strafes, attack prep, and a 19-frame burst that calls `0x1002f030` at frame 163 and when the loop ends), keeping the sentry in constant lateral motion.【F:docs/kigrax_hlil_notes.md†L8-L20】

### Current source implementation (`src/game/m_kigrax.c`)
- `kigrax_init_moves` rebuilds the HLIL frame ranges/AIs, and the stand/search/run selectors randomise between hover/patrol/dash loops so the source pacing matches the recovered state machine.【F:src/game/m_kigrax.c†L14-L220】
- The attack entry (frames 139–149) now feeds the 19-frame burst that fires on frame 163 before rejoining the strafing selectors, mirroring the HLIL cadence, while the corpse cleanup swaps to MOVETYPE_TOSS and schedules the hover-style explosion thinker.【F:src/game/m_kigrax.c†L229-L376】
- The reconstructed salvo still emits a single bolt and never toggles the crouched hull that `0x1002f030` handles in the binary, so the bounding-box/salvo routine remains a TODO.【F:docs/kigrax_hlil_notes.md†L20-L20】【F:src/game/m_kigrax.c†L260-L307】
- Pain and death still reuse placeholder two-frame mmoves, so stagger durations, gibbing hooks, and recovery logic do not yet mirror the retail DLL.【F:src/game/m_kigrax.c†L313-L372】

### Regression coverage
- `tests/test_kigrax_regression.py` now asserts that the spawn defaults and mmove ranges stay aligned with the decoded HLIL data in addition to the existing corpse thinker checks.【F:tests/test_kigrax_regression.py†L1-L126】【F:tests/test_kigrax_regression.py†L128-L169】

## Retail footage status
Surviving DM2 recordings (`demo1.dm2`, `demo2.dm2`) are present under `pack/demos/`, but the current toolchain still lacks a Quake II demo player, so no fresh footage or screenshots can be captured to corroborate ambiguous HLIL states.【40f0a8†L1-L2】
